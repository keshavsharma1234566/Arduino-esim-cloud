name: Containers

on:
  push:
    branches: [ master, devops ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Login to docker
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login https://docker.pkg.github.com -u ${{ github.repository_owner }} --password-stdin

    - name: Build the docker-compose stack
      run: |
        cp .env .env.prod
        docker-compose -f docker-compose.prod.yml --env-file .env.prod pull --ignore-pull-failures
        docker-compose -f docker-compose.prod.yml --env-file .env.prod build

    - name: Run the docker-compose step
      run: docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d

    - name: Check running containers
      run: docker ps -a

    - name: Publish images
      if: github.ref == 'refs/heads/master'
      run: docker-compose -f docker-compose.prod.yml --env-file .env.prod push

name: Master Containers

on:
  push:
    branches: [ master ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Login to docker
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login https://docker.pkg.github.com -u ${{ github.repository_owner }} --password-stdin

    - name: Build the docker-compose stack
      run: |
        cp .env .env.prod
        docker-compose -f docker-compose.prod.yml --env-file .env.prod pull --ignore-pull-failures
        docker-compose -f docker-compose.prod.yml --env-file .env.prod build
    - name: Run the docker-compose step
      run: docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d

    - name: Check running containers
      run: docker ps -a

    - name: Publish images
      run: docker-compose -f docker-compose.prod.yml --env-file .env.prod push

name: ESLint eda-frontend

on:
  push:
    paths: [ 'eda-frontend/**' ]

jobs:
  eslint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: darshkpatel/eslint-action@master
        with:
          repo-token: ${{secrets.GITHUB_TOKEN}}
          source-root: 'eda-frontend'

name: React Build and Tests

on:
  push:
    paths: [ 'eda-frontend/**' ]
  pull_request:
    paths: [ 'eda-frontend/**' ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Use Node js
      uses: actions/setup-node@v1
      with:
        node-version: 10.5.0
    - name: Install packages,lint,build and Unit testing
      working-directory: ./eda-frontend
      run: |
        export NODE_OPTIONS=--max_old_space_size=4096
        npm install
        CI=true npm run build
        CI=true npm test

name: Angular Build and Tests

on:
  push:
    paths: [ 'ArduinoFrontend/**' ]
  pull_request:
    paths: [ 'ArduinoFrontend/**' ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Use Node js
      uses: actions/setup-node@v1
      with:
        node-version: 10.5.0
    - name: Install packages,lint,build and Unit testing
      working-directory: ./ArduinoFrontend
      run: |
        npm install
        npm run lint
        npm run build -- --prod
        npm test -- --configuration=ci

name: Containers

on:
  push:
    #Until changes are merged to master initially
    branches: [ develop, docker-images ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Login to docker
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login https://docker.pkg.github.com -u ${{ github.repository_owner }} --password-stdin

    - name: Build the docker-compose stack
      run: |
        docker-compose -f docker-compose.dev.yml --env-file .env pull --ignore-pull-failures
        docker-compose -f docker-compose.dev.yml --env-file .env build

    - name: Run the docker-compose step
      run: docker-compose -f docker-compose.dev.yml --env-file .env up -d

    - name: Check running containers
      run: docker ps -a

    - name: Publish images
      run: docker-compose -f docker-compose.dev.yml --env-file .env push

name: Django Build and Tests

on:
  push:
    paths: [ 'esim-cloud-backend/**' ]
  pull_request:
    paths: [ 'esim-cloud-backend/**' ]


jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Login to docker
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login https://docker.pkg.github.com -u ${{ github.repository_owner }} --password-stdin
    - name: Build Images
      run: |
        docker-compose -f docker-compose.dev.yml --env-file .env pull --ignore-pull-failures
        docker-compose -f docker-compose.dev.yml --env-file .env build
    - name: Run Django Test Suite
      run: |
        docker-compose -f docker-compose.dev.yml run django python manage.py test
